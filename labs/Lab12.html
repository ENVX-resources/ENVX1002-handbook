<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="The University of Sydney">

<title>Lab 12 - Non-linear models ‚Äì ENVX1002 Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0f9ab1647048413cbab2c193a4590f70.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-c44ea0d3856dd046b875089f7fe24e46.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2b359d2b6993200113079de798898405.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-21abdccd215aee3adb44e4f991220b7f.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #000;
      }

      .quarto-title-block .quarto-title-banner {
        color: #000;
background: #FCEDE2;
      }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="docked">

<div id="quarto-search-results"></div>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../000-rguide.html"><strong>üñ•Ô∏è Computer labs</strong></a></li><li class="breadcrumb-item"><a href="../labs/Lab12.html">Lab 12 - Non-linear models</a></li></ol></nav>
      <h1 class="title">Lab 12 - Non-linear models</h1>
            <p class="subtitle lead"><a href="../index.html">ENVX1002 Handbook</a></p>
                  <div>
        <div class="description">
          The University of Sydney
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Semester 1, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#before-we-begin" id="toc-before-we-begin" class="nav-link active" data-scroll-target="#before-we-begin">Before we begin</a></li>
  <li><a href="#polynomials" id="toc-polynomials" class="nav-link" data-scroll-target="#polynomials">Polynomials</a>
  <ul class="collapse">
  <li><a href="#exercise-1-interpreting-polynomials" id="toc-exercise-1-interpreting-polynomials" class="nav-link" data-scroll-target="#exercise-1-interpreting-polynomials">Exercise 1: Interpreting polynomials</a></li>
  <li><a href="#exercise-2-fitting-polynomials-in-r" id="toc-exercise-2-fitting-polynomials-in-r" class="nav-link" data-scroll-target="#exercise-2-fitting-polynomials-in-r">Exercise 2: Fitting polynomials in R</a></li>
  </ul></li>
  <li><a href="#exponential-function" id="toc-exponential-function" class="nav-link" data-scroll-target="#exponential-function">Exponential function</a>
  <ul class="collapse">
  <li><a href="#exercise-3-initial-estimates-for-exponential-growth-function" id="toc-exercise-3-initial-estimates-for-exponential-growth-function" class="nav-link" data-scroll-target="#exercise-3-initial-estimates-for-exponential-growth-function">Exercise 3: Initial estimates for exponential growth function</a></li>
  <li><a href="#exercise-4-exponential-growth-models" id="toc-exercise-4-exponential-growth-models" class="nav-link" data-scroll-target="#exercise-4-exponential-growth-models">Exercise 4 : Exponential growth models</a></li>
  </ul></li>
  <li><a href="#logistic-function" id="toc-logistic-function" class="nav-link" data-scroll-target="#logistic-function">Logistic function</a>
  <ul class="collapse">
  <li><a href="#exercise-5-logistic-models" id="toc-exercise-5-logistic-models" class="nav-link" data-scroll-target="#exercise-5-logistic-models">Exercise 5: Logistic models</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Lab12.pdf"><i class="bi bi-file-pdf"></i>Typst</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Calculate ‚Äúby hand‚Äù the initial estimates of the parameters of a non-linear model</li>
<li>Interpret tables of regression coefficients for polynomials to perform hypothesis testing</li>
<li>Fit polynomials and non-linear models to data using least-squares fitting using the SOLVER add-in in Excel</li>
<li>Fit polynomials and non-linear models to data in R, and interpret the outputs</li>
</ul>
</div>
</div>
<section id="before-we-begin" class="level2">
<h2 class="anchored" data-anchor-id="before-we-begin">Before we begin</h2>
<p>Create your Quarto document and save it as <code>Lab-12.qmd</code> or similar.</p>
<p>The following data files are required:</p>
<ol type="1">
<li><a href="data/east_creek.csv">east_creek.csv</a></li>
</ol>
<p>Over the past few weeks you have explored linear models and how to interpret model summary output. Again we have stepped up the complexity, now venturing into the world of non-linear models.</p>
<p>This practical focuses on fitting non-linear models to data with an emphasis on 3 important classes of functions that all budding biologists and environmental scientists should know</p>
<ul>
<li>polynomials,</li>
<li>exponential models, and</li>
<li>logistic models.</li>
</ul>
<p><strong>A question before we begin:</strong></p>
<p>What are some advantages and disadvantages of non-linear models as compared to polynomials?</p>
<p><br></p>
</section>
<section id="polynomials" class="level2">
<h2 class="anchored" data-anchor-id="polynomials">Polynomials</h2>
<div class="pad-box-mini" style="background-color: #f2f2f2; padding:10px;">
<p><strong>Quadratic</strong></p>
<p><span class="math inline">\(y = \beta_0 + \beta_1 x + \beta_2 x^2\)</span></p>
<p>where the parameters are the y-intercept (<em>b<sub>0</sub></em>), the linear component (<em>b<sub>1</sub></em>) and the quadratic component (<em>b<sub>2</sub></em>).</p>
<p>If <em>b<sub>2</sub></em> is negative then the shape of the function is convex upwards, i.e.&nbsp;<em>y</em> increases with <em>x</em> until reaches a peak and then <em>y</em> decreases.</p>
<p>It is easy to understand so it has been commonly used for modelling the response of yield to inputs such as fertiliser, seeding rates. This is despite much criticism for being unrealistic.</p>
<p>Limitations:</p>
<ol type="i">
<li><p>rate of increase to peak is same as rate of decrease past peak</p></li>
<li><p>does not level off as <em>x</em> becomes small or very large, <em>y</em> just keeps increasing or decreasing.</p></li>
</ol>
<p><strong>Cubic</strong></p>
<p><span class="math inline">\(y = \beta_0 + \beta_1 x + \beta_2 x^2 + \beta_3 x^3\)</span></p>
<p>Compared to the quadratic model which has 1 turning point, a cubic model has 2 turning points.</p>
</div>
<p><br></p>
<section id="exercise-1-interpreting-polynomials" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-interpreting-polynomials">Exercise 1: Interpreting polynomials</h3>
<p>A study was performed to examine the soil properties that control the within-field variation in crop yield. The focus of this question is on soil pH which (among other things) controls the availability of nutrients to plants.</p>
<p>This exercise does not require you to read in any data, but rather focus on interpreting the model output and comparing the models.</p>
<p>The figure below shows the raw observations of yield plotted against pH with three models fitted; a linear model, quadratic polynomial and a cubic polynomial.</p>
<ol type="a">
<li>which line corresponds to which model?</li>
</ol>
<p><br></p>
<ol start="2" type="a">
<li>based on the output from the 3 models below, which model fits the data best? Note: no hypothesis testing yet, just how well the model fits the data (R<sup>2</sup>).</li>
</ol>
<!-- -->
<ol type="1">
<li>Linear model:</li>
</ol>
<ol start="2" type="1">
<li>Quadratic model:</li>
</ol>
<ol start="3" type="1">
<li>Cubic model:</li>
</ol>
<p><br></p>
<ol start="3" type="a">
<li>Use the R output to perform hypothesis testing to find the best model. Write out the hypotheses you are testing.</li>
</ol>
<p><br></p>
</section>
<section id="exercise-2-fitting-polynomials-in-r" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-fitting-polynomials-in-r">Exercise 2: Fitting polynomials in R</h3>
<p>This exercise will use real data from a yield-fertiliser trial in Bedfordshire, United Kingdom.</p>
<p>First thing we can do is fit a linear model to the fertiliser data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create fertiliser and yield objects</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>fert <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">170</span>, <span class="dv">225</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>yield <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">3.32</span>, <span class="fl">5.23</span>, <span class="fl">5.41</span>, <span class="fl">5.02</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fits a linear model and saves it to an object called lin.mod</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>lin.mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(yield <span class="sc">~</span> fert)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarises key features of model</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lin.mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = yield ~ fert)

Residuals:
      1       2       3       4 
-0.4469  0.6727  0.2995 -0.5252 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)  
(Intercept) 3.766929   0.634765   5.934   0.0272 *
fert        0.007904   0.004243   1.863   0.2035  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.7134 on 2 degrees of freedom
Multiple R-squared:  0.6344,    Adjusted R-squared:  0.4515 
F-statistic:  3.47 on 1 and 2 DF,  p-value: 0.2035</code></pre>
</div>
</div>
<ol type="a">
<li>What is the model fit like in this model?</li>
</ol>
<p>Fit and plot a quadratic polynomial in R. In R a quadratic polynomial can be fitted using the following lines of code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable which is the square of the fertilizer rates</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>fert2 <span class="ot">&lt;-</span> fert<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the quadratic model incorporating fert2</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>quad.mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(yield <span class="sc">~</span> fert <span class="sc">+</span> fert2)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(quad.mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = yield ~ fert + fert2)

Residuals:
        1         2         3         4 
-0.005611  0.024528 -0.032791  0.013874 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)  3.326e+00  4.324e-02   76.92  0.00828 **
fert         2.786e-02  9.014e-04   30.91  0.02059 * 
fert2       -9.064e-05  3.921e-06  -23.12  0.02752 * 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.0436 on 1 degrees of freedom
Multiple R-squared:  0.9993,    Adjusted R-squared:  0.998 
F-statistic: 731.7 on 2 and 1 DF,  p-value: 0.02613</code></pre>
</div>
</div>
<ol start="2" type="a">
<li>What is the fit like for our quadratic model? is it better than our linear model?</li>
</ol>
<p>In Excel it is easy to fit a line, by creating a scatterplot, then <strong>add Trendline‚Ä¶</strong> and selecting <strong>Polynomial</strong> (2nd order).</p>
<p>To fit our polynomial line in R, we need to obtain model predictions first.</p>
<p>To plot model predictions you first need to predict at fine intervals of the predictor to make a continuous plot that is not jagged or stepped. To create a new prediction dataset you can use the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creates a sequence of numbers from 0 to 225 going up in increments of 1</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>new.fert <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">225</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use our model to predict at the values in the new prediction dataset, in this case <code>new.fert</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>new.pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(quad.mod, <span class="fu">list</span>(<span class="at">fert =</span> new.fert, <span class="at">fert2 =</span> new.fert<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The general form of the <code>predict</code> function is <code>predict(model object, list object)</code>.</p>
<p>The list object tells R what object contains the data we will use to predict. For example in our case the model was built on fert and fert2 so we have to tell the predict function what object contains the new values for each of these, in our case new.fert.</p>
<p>Now we plot the raw observation as points and add an overlay of the model fit as lines:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fert, yield, <span class="at">xlab =</span> <span class="st">"Fertilizer"</span>, <span class="at">ylab =</span> <span class="st">"Yield"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(new.fert, new.pred) <span class="co"># Adds lines to original plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
</section>
<section id="exponential-function" class="level2">
<h2 class="anchored" data-anchor-id="exponential-function">Exponential function</h2>
<div class="pad-box-mini" style="background-color: #f2f2f2; padding:10px;">
<p><span class="math inline">\(y=y_0e^{kx}\)</span></p>
<p>where the parameters are <em>y<sub>0</sub></em> which is the multiplier which expresses the starting or final value, and <em>k</em> which is negative for exponential decay and positive for the exponential growth.</p>
<p>The half life (for decay) or doubling time (for growth) can be calculated as</p>
<p><span class="math inline">\(\frac{log_e 2}{k}\)</span></p>
<p>Limitations:</p>
<ol type="i">
<li><p>harder to fit than polynomials</p></li>
<li><p>exponential growth has no horizontal asymptote; keeps going up.</p></li>
</ol>
</div>
<p><br></p>
<section id="exercise-3-initial-estimates-for-exponential-growth-function" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-initial-estimates-for-exponential-growth-function">Exercise 3: Initial estimates for exponential growth function</h3>
<p>In this exercise we will find initial estimates of the parameters of an exponential growth model by visual assessment of plots of the data and/or rough calculations. The initial estimates of the parameters are needed as starting points for the iterative fitting methods we will use in the practicals, e.g.&nbsp;SOLVER in Excel and the <code>nls()</code> function in R.</p>
<p>The plot and table below presents the population of the world from 1650-1965.</p>
<p>We wish to model the data with an exponential growth function of the form;</p>
<p><span class="math inline">\(y=y_0e^{kx}\)</span></p>
<p>where</p>
<ul>
<li><p><em>y</em> is the population in the year <em>x</em>,</p></li>
<li><p>y<sub>0</sub> is the population in 1650 and</p></li>
<li><p><em>k</em> is the rate constant.</p></li>
</ul>
<p><br></p>
<ol type="a">
<li>Provide an initial estimate of y<sub>0</sub>.</li>
</ol>
<p>The parameter <em>k</em> can be estimated from a linear model fitted to log<sub>e</sub> population against year.</p>
<p>Rather than formally fitting a linear model you could estimate the slope approximately by using the smallest and largest value to estimate the slope and therefore <em>k</em>.</p>
<ol start="2" type="a">
<li>Use this approach to estimate k.</li>
</ol>
<p>Hint: <span class="math display">\[
slope = k = \frac{log_e y_{max} - log_e y_{min}}{x_{max} - x_{min}}
\]</span></p>
<ol start="3" type="a">
<li>For an exponential growth model the doubling time of a population can be estimated by log<sub>e</sub>2 /k.</li>
</ol>
<p>Examine the graph and/or table to estimate the doubling time and use this to estimate <em>k</em>. You will have to make <em>k</em> the subject in the equation for estimating the doubling time.</p>
<ol start="4" type="a">
<li>How similar were the estimates of <em>k</em>?</li>
</ol>
<p><br></p>
</section>
<section id="exercise-4-exponential-growth-models" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4-exponential-growth-models">Exercise 4 : Exponential growth models</h3>
<p>This data is from Jenkins &amp; Adams (2010) who studied soil respiration rates against temperature for different vegetation communities in the Snowy Mountains. They fitted an exponential growth model to the data.</p>
<p>The purpose of this exercise is to illustrate the dangers of using Excel‚Äôs in-built functions for statistics more complex than calculating means and fitting simple models.</p>
<p>Plot the data in Excel and using the <strong>Add Trendline‚Ä¶</strong> option. Make sure tick the option for displaying the equation in the graph.</p>
<ol type="a">
<li>The researchers performed the experiment up to a temperature of 40 degrees C, would you expect exponential growth in the respiration rate to continue if high temperatures were considered? Is there a better model?</li>
</ol>
<p>Now fit the same model in R using the nls function. Code to get you started is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">25</span>,<span class="dv">30</span>,<span class="dv">35</span>,<span class="dv">40</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>respiration<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">11</span>,<span class="dv">18</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">##Initial parameters</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>exp.mod<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="at">y0=</span><span class="fl">1.0</span>,<span class="at">k=</span><span class="fl">0.1</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">##Fits exponential model</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>res.exp<span class="ot">&lt;-</span><span class="fu">nls</span>(respiration <span class="sc">~</span> y0 <span class="sc">*</span> <span class="fu">exp</span>(k<span class="sc">*</span>temp), <span class="at">start=</span>exp.mod,<span class="at">trace=</span>T)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="do">##Summarise model</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res.exp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="a">
<li>Now you can fit a line to the plot. Does this look similar to your trendline in Excel?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plots raw data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp,respiration,<span class="at">xlab=</span><span class="st">'Temperature'</span>,<span class="at">ylab=</span><span class="st">'Respiration'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Creates new dataset for predictions ( 5 to 40 at an interval of 1)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>temp.new<span class="ot">&lt;-</span><span class="fu">seq</span>(<span class="dv">5</span>,<span class="dv">40</span>,<span class="dv">1</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Makes predictions onto temp.new</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>pred.exp<span class="ot">&lt;-</span><span class="fu">predict</span>(res.exp,<span class="fu">list</span>(<span class="at">temp=</span>temp.new))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Adds model fit to existing plots</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span> (temp.new,pred.exp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compare the parameters values between Excel and R. You can extract the RSS value from an <code>nls</code> object by using the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">deviance</span>(res.exp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="a">
<li>Calculate the RSS value for the Excel exponential model. Based on this, which is the better model?</li>
</ol>
<p>When faced with the need to fit an exponential function, one approach that was used before computing power became readily accessible was to log the <em>y</em> values which linearises the relationship with <em>x</em>, enabling the modeller to use a simple linear model.</p>
<p>If we linearise, model would be <span class="math inline">\(log_e(y) = b_0 + b_1x\)</span>, where <span class="math inline">\(e^{b_0}\)</span> is the <em>y<sub>0</sub></em> parameter in an exponential model, and <em>b<sub>1</sub></em> is the <em>k</em> parameter in the exponential model. This is similar to what was demonstrated in the lecture this week.</p>
<p>In Excel, log the soil respiration data and fit a linear model. You will see that the fitted model gives the same values as the exponential model fitted to the untransformed data.</p>
<p>If you compare the R<sup>2</sup> values for both you will see they are the same. This means that Excel reports the R<sup>2</sup> of the linear model fitted to logged respiration as the R<sup>2</sup> of the exponential model fitted to the raw data. This is naughty of Excel.</p>
<div class="pad-box-mini" style="background-color: #f2f2f2; padding:10px;">
<p>For the dataset used here the exponential model fits it so well the Excel approach is only slightly different to the correct approach used in R.</p>
<p>In cases where the model does not fit the data so well the differences would be larger. Logarithm makes smaller values larger and larger values smaller.</p>
<p><strong>WHY IS THIS SUB-OPTIMAL?</strong></p>
<ul>
<li><p>Regression modelling assumes that the residuals are normally distributed so logging normally distributed data will change the distribution to a non-normal one ‚Äì it is best to analyse the data without transformation.</p></li>
<li><p>Modelling data on the logged scale reduces the impact that larger values have on minimising the RSS but when you plot the fitted model with the original data you may observe large discrepancies for larger values. In other words, using a linear model on the log(data) can result in a higher discrepancy for larger values when plotting the fitted model on the original data. Therefore, the model fitted to the logged data is not necessarily the best on the original data.</p></li>
<li><p>The reporting of the R-squared on the logged data on a model purported to be fitted to untransformed data is just wrong as the R-squared on the log scale will be better as the variation in the data has been reduced but we really want to know how well an exponential model fits the raw data.</p></li>
</ul>
</div>
<p><br></p>
</section>
</section>
<section id="logistic-function" class="level2">
<h2 class="anchored" data-anchor-id="logistic-function">Logistic function</h2>
<div class="pad-box-mini" style="background-color: #f2f2f2; padding:10px;">
<p>There are several versions of the logistic function. We will use the following:</p>
<p><span class="math display">\[ y = \frac{Asym}{1+e^{\frac{xmid-x}{scal}}} \]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(Asym\)</span> is the maximum value of <span class="math inline">\(y\)</span> (upper limit, horizontal asymptote).</li>
<li><span class="math inline">\(xmid\)</span> is the value of <span class="math inline">\(x\)</span> when <span class="math inline">\(y\)</span> is halfway between the lower and upper limits (inflection point, <span class="math inline">\(y = 0.5 \times Asym\)</span>).</li>
<li><span class="math inline">\(scal\)</span> is the rate of change: the rate at which <span class="math inline">\(y\)</span> approaches the upper limit.</li>
</ul>
<p>Commonly used to model growth that has a sigmoid shape, i.e.&nbsp;where growth is initially slow, then picks up to a maximum, then slows down again as the system reaches a maximum.</p>
<p>Limitations:</p>
<p>Harder to fit than polynomials.</p>
</div>
<p><br></p>
<section id="exercise-5-logistic-models" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5-logistic-models">Exercise 5: Logistic models</h3>
<p>In this exercise you will model the yield of pasture over time (since sowing).</p>
<p>Note, we will assume the yield at sowing = 0 is 0 t/ha, which allows us to use the equation above (that is pre-defined in <code>SSlogis()</code>).</p>
<p>If this were not the case, we would need to use a slightly different equation; <span class="math inline">\(y = y_0 + \frac{Asym}{1+e^{-scal(x-xmid)}}\)</span>, where <span class="math inline">\(y_0\)</span> is the yield at sowing.</p>
<ol type="a">
<li>Fit the model in R using the <code>nls</code> function. Estimate the starting<br>
parameters manually (using the previous exercise and the equation above as a guide). Then use the <code>SSlogis()</code> function to automatically estimate the parameters (see L12, Tut12 or the <a href="https://envx-resources.github.io/ENVX1002-handbook/module03/043-nonlinear.html">handbook</a>).</li>
</ol>
<ol start="2" type="a">
<li>Plot the fitted model with the observations.</li>
</ol>
<ol start="3" type="a">
<li>Compare the final model parameters when we provide starting estimates, and when we use <code>SSlogis()</code>. Are they the same?</li>
</ol>
<div class="pad-box-mini" style="background-color: #f2f2f2; padding:10px;">
<p><strong>STARTING VALUES</strong></p>
<p>When fitting non-linear functions (i.e.&nbsp;logistic or exponential) using iterative procedures such as <code>nls</code> or SOLVER the starting estimates of the parameters need to be approximated. If the values are too far, the model will not run and return an error.</p>
<p>The best way to ensure that you have suitable starting values is to plot the data with the predictions overlaid for your starting parameters. You can then see how close your initial model is to the data.</p>
<p>The reason we go through the process of estimating parameters is because <code>nls</code> and SOLVER can fit <em>any</em> nonlinear equation. They are more versatile</p>
<p>Realistically, most nonlinear relationships you would fit are covered by a self-starting function; i.e.&nbsp;<code>SSlogis()</code>, <code>SSasymp()</code>, or <code>nlraa::SSexpf()</code>. These estimate the parameters for you and are more efficient to run. We recommend using these when suitable.</p>
</div>
<p><br></p>
<p>That‚Äôs it for Module 3! Great work exploring non-linear models!</p>
<p>Thank you all (students and demonstrators!) for your hard work and enthusiasm throughout this Module. Good luck with Project 3 and the final exam!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ENVX-resources\.github\.io\/ENVX1002-handbook\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>